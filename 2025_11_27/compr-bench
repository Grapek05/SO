#!/bin/bash

# Ustawienie locale na C, aby 'bc' otrzymywał kropki zamiast przecinków w liczbach zmiennoprzecinkowych
LC_NUMERIC=C

if [ "$#" -eq 0 ]; then
    echo "Użycie: $0 <katalog1> [katalog...]"
    echo "./compr-bench /tmp/data/random /tmp/data/empty /tmp/data/various"
    exit 1
fi

tmp_dir=$(mktemp -d)

cleanup() {
    rm -rf "$tmp_dir"
}
trap cleanup EXIT

benchmark_tool() {
    local tool_name=$1
    local compress_cmd=$2
    local decompress_cmd=$3
    local compressed_file=$4
    local tar_file="$tmp_dir/archive.tar"

    # kompresja
    local start=$(date +%s.%N)
    eval "$compress_cmd" > /dev/null 2>&1
    local end=$(date +%s.%N)
    local comp_time=$(echo "$end - $start" | bc -l)

    # ratio
    if [ -f "$compressed_file" ]; then
        local orig_size=$(stat -c%s "$tar_file")
        local comp_size=$(stat -c%s "$compressed_file")
        # %: (comp / orig) * 100
        local ratio=$(echo "scale=2; ($comp_size / $orig_size) * 100" | bc -l)
    else
        local ratio="Error"
    fi

    # dekompresja
    start=$(date +%s.%N)
    eval "$decompress_cmd" > /dev/null 2>&1
    end=$(date +%s.%N)
    local decomp_time=$(echo "$end - $start" | bc -l)

    printf "%s\t%.9f\t%.10f\t%s%%\n" "$tool_name" "$comp_time" "$decomp_time" "$ratio"

    rm -f "$compressed_file"
    rm -f "$tar_file.out" 
}

for dir in "$@"; do
    echo "---------------------------------------------------"
    echo "Katalog: $dir"

    tar cf "$tmp_dir/archive.tar" -C "$(dirname "$dir")" "$(basename "$dir")" 2> /dev/null
    
    # Nagłówek tabeli
    printf "name\tcompress\tdecompress\tratio\n"

    tf="$tmp_dir/archive.tar"

    # -k zachowuje plik wejściowy
    # -f nadpisuje
    benchmark_tool "gzip" \
        "gzip -k -f '$tf'" \
        "gzip -d -k -f '$tf.gz'" \
        "$tf.gz"

    benchmark_tool "bzip2" \
        "bzip2 -k -f '$tf'" \
        "bzip2 -d -k -f '$tf.bz2'" \
        "$tf.bz2"

    benchmark_tool "xz" \
        "xz -k -f '$tf'" \
        "xz -d -k -f '$tf.xz'" \
        "$tf.xz"

    benchmark_tool "zstd" \
        "zstd -k -f '$tf'" \
        "zstd -d -k -f '$tf.zst'" \
        "$tf.zst"

    benchmark_tool "lz4" \
        "lz4 -k -f '$tf' '$tf.lz4'" \
        "lz4 -d -k -f '$tf.lz4'" \
        "$tf.lz4"

    # 7z a = add
    # 7z x = extract
    # -y = "yes" dla wszystkich pytań
    # -o = katalog wyjściowy
    benchmark_tool "7z" \
        "7z a '$tf.7z' '$tf'" \
        "7z x '$tf.7z' -o'$tmp_dir/7z_out' -y" \
        "$tf.7z"
    rm -rf "$tmp_dir/7z_out"

    rm -f "$tf"
    echo ""
done
